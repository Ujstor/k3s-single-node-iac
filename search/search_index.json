{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"K3S Single Node Multi Cluster IaC","text":"<p>Minimal k3s single node deployment on Hetzner Cloud with Terraform and Ansible and managed with ArgoCD.</p> <p></p> <p>K3s is stripped down to minimal components. The only components we have are CoreDNS, local-path-provisioner, and metrics-server. Everything else is disabled and configured with custom Helm charts.</p> <p></p> <p>The clusters will be automatically bootstrapped and managed with ArgoCD.</p>"},{"location":"#prerequisites","title":"Prerequisites","text":"<p>Before you begin, ensure you have the following:</p> <ul> <li>Hetzner Cloud account (20$ free credits)</li> <li>Terraform</li> <li>Helm</li> <li>kubectl</li> <li>K9s (optional but recommended)</li> </ul> <p>Helm charts and Terraform modules are custom-made with the intention to be reusable and reconfigurable:</p> <ul> <li>Helm Charts System</li> <li>Helm Charts Apps</li> <li>Helm Charts Github Apps</li> <li>Terraform Hetzner Modules</li> </ul>"},{"location":"deployment-logs/ansible/","title":"Ansible","text":"<pre><code>\uf432 docker run --rm -it \\\n    -v $(pwd)/inventory.yml:/config/inventory.yml \\\n    -v $(pwd)/terraform/hetzner-node/.ssh/k3s_hetzner_key:/secrets/ssh_key \\\n    -v $(pwd)/terraform/hetzner-node/.ssh/k3s_hetzner_key.pub:/secrets/ssh_key.pub \\\n    ansible-k3s\n\nroot@0ffa9f2d3006:/ansible# cat /config/inventory.yml\n---\nserver:\n  hosts:\n    api.k3s.ujstor.com:\n  vars:\n    k3s_version: v1.31.3+k3s1\n    api_endpoint: \"{{ groups['server'] | first }}\"\n    extra_server_args: &gt;-\n      --cluster-cidr=10.255.0.0/16\n      --service-cidr=10.254.0.0/16\n      --disable servicelb\n      --disable traefik\n      --flannel-backend=none\n      --egress-selector-mode=disabled\n      --disable-cloud-controller\n      --disable-helm-controller\n      --disable-network-policy\n      --disable-kube-proxy\n      --tls-san {{ api_endpoint }}\n\nroot@0ffa9f2d3006:/ansible# cat /secrets/ssh_key\n-----BEGIN RSA PRIVATE KEY-----\nMIIJKQIBAAKCAgEAw0L96QGPOXBduAXp3cuRRfJuPsAPAxyp2iYsHIWiyISsc77l\nlSPD3BmBe2U0S4rDwqOGthjvGwiwH7vvhvvw7ald/9gb0Gua+tOnDmGiBHnuCQfc\n6O0CIY8pVK0zfnxRqEN2Z18fXzagPNErkasN1SBmgJ2CfzbbvLTRfg8MDyTY+gSX\n68Y0ZAeqfTBIVqvq377lNex/PoraacwN9bdCCfF1g9w2nlIQyJDcN+g7OGRKsRT5\ntUh2N9UP92ZNttDeAow2UkC/IGz6+aljbH06k6qvmSlXy04th79Acis5LFq5TE16\noofQmKhvHPEHtAhKiIJGi/Tj8fxPqNs99ICobyzvqukjhhvOuCFzZeWqpnXvTduR\npLjdTZK/TsuWgcLA2rKUNpsWNrM5PzgIZPjlYnHgd1iZWvbP8oKzrCwdLW0vT+sd\np2TS4TEjJwosj0zp+xxkQePciFi+74/fSqZLTqQgayaQPqW3JFFzwWqgGvaz8Ino\n3FS3VxZ4j6tSUmoa02s1A0jyTZhkurY4Udw/pfUzyyG67jccLMfj444K5toKURMq\noAOWvgnwz8BBDVLwhiMvZSViWRVVGf/PDRmhnmvyBy6Awhs1uyZp8tgEkCIJ6M/+\nhYxihwyLmulC8fWQJPydfbc4V1Wie4usecs0RcmtArAalsHRZiLafx9chzECAwEA\nAQKCAgEAuJw8B/KLgVj1oqkkpahzn1hIV1eqWdzd0fzJM+Y9M6wMiBpyYYFBCnWq\n8AmNWebGkt2c3cnRNxQNwNMk8dB9x5Wb4+pk0bcK/h7iETzJu8W0AiHHAQokO6po\n/0AKMYpEgfvWlIFg3dp9wUJaGQ1KtLg/cVZ6LOCm/FFQyAhd9Gt4IVn6cNYibni4\n/keJ/TfphsWrXEJPQ8hwHBrrD+fFrjT2UEcB9MnOSHJ9YvZUF0rrO2WDeZwa+Uqe\nH+A/lZsAbBQ4v6erjHK9DxLRh58WpMp53ysxcGxnq7JssgSft4nHK5cNXWFfHRYS\nh6BzEgnMvie9n1FXulA82H8AooyJsXpNkWqrmMp2VYMZSNOpX/rKOA43lCBWtmZS\nIIlTvUOy5XPATzXqd3AmI0UUcmHZHUE2vUe/mkw3aUdECIJzLoquoN4sVl0Dg3Xm\nXbnBpUoVPDPZkv4AlvF3MGv1qVM3f/7Cz/l9UxSYpm2YfXAsmhr0/vSozo5wgjTk\n3Ony5ykjQ4XdU0YJ1ssTiUVNnMrHGROXJ6TgfnnobeJQ4hPzg6t9JzCvkCs0jFCv\nHCL0lq2+I0a27RYo2JYHQTdUePyNACYiNsWho/Pe/iBjQTmg6rT8sj4gDA8spmR/\ndurSW4R+6bkNaILGc+T/pszB3DKE2qvs3GuVQbBbAY50DV5pX2kCggEBAPa8+nmA\nE2MlrKHFBr5p1V+RIsYoHruWZF4nVty+bcLAMGsyvOUEsx5P5LO9q3RT0rclzPPl\nspQwst1Qt+a6qhtPSuNHmxvuP6TxaXWg3FNxjSW0U0nglaZlLZICKuzgY8cgox0I\nXasVgVT13XMRZWEvhWNoFxZNAqCUqiIgp6fCRcHvQ3+O0TG2b3Ub3blBrofRT4pP\ngfAEEw4TrWk4pkZvcsaReIm6UYrQ2mnOTEWLtcNZJz98d6gyYmQ4zn4/uV38HBpn\ncnJarXFmCdAkmCaNkUIInX7X4ik+zPijci7H/Dv1GXrfBGfeQb8Q9ltcRYE6sXL3\n2qxffefl9kGb+vcCggEBAMqXWg+EfyYZz9ua66wVCCswqwL4bK4DexQVlL6gp6Xe\nIxVGLagMFnkIkvcmiuu8YF0h+jrN1+petRhpgf1uRouJ4vuzbFrESYXfrDXtXW+K\nRLnjV3y1qo0TOWOdl3hM//l4dhtoJWPKAY6J7PReIzI/a/pnVv3zRafLi8UrJq5f\nRt3H+Kw0+Cd5jImw2c37P6CuZjkP+CVilc9m1qS2IEnUDf6h7RXoQjNnZeGYqrc4\n9zDmxvIgr6mBtpjk91EUlP8ksS3tflcL+sMl1P9OMG2eVvbmr1zfeaRm09SSnZHf\nDBJGuz7oERUI5sckj84jY5PqZ2pLhkafzQnftDqtHRcCggEAMmpUx6S60WRuTLOk\neB3J4ngWYeTququ1IGPrZLloVgXNHupEHIuESepLMcrMkL1b7d5EbYV+orb8pSoM\nGZIElgXyqFQGRoO872gAg2919XrbO1wINK02BsTftdjJipMi8BokGheOhBmlzoVa\nVVu1mlEKcVBgf0cHBWa7CLQhba7NcB4Cbbrx1bWQOp6SBHt+PPQwy3MJetBqUFMG\n+NwBZZz6F8a7mXC/npykNEBZ50/vuNWrplY5YN3CqvXMg5Fjv+d2mpKOmP0cOXJ/\nCM+hYydECfkWrUdRR9o0KY3EE/j6+glPxoJxNQP97Rt7KxnEfe5POc2ZGeV9JXgg\nhDFp6wKCAQAMwSacX30Zyvo5GzHHLbPL9E5v62/8LJ/tDcbFkZu8Z5XR2w84yzoG\n+LE3+ic43C0878yvMxJq4PeJx+q1J+ItGss9iXhC5qSyVviilIUTZqMZCOUTJuTL\n6O/uA5frrP1YmWrmItJny+n5LVnLsLmKik+j/imN52j1PW1ZRnQy+jCd+d8ACH2v\nDon4iTfNLgo9dX1eDlFTGTfRTOoqiITT4RPYeh1RCcRRNCtH3rKwwlddrsnLqJ8m\njtIOIiwn4KHYxliZSaBwnoJ1EsasJCIMZLGY7cEQmckwvoCLm4dsDZzW8bkMJtQc\nfOj6lKSxF61HPLSyDnsvqxPfkUPphciVAoIBAQDwV0U4NuNURhVpf1HqH+JysGez\nAkd5ZoQxHfUR9IvhteCLralIV2210oRqIEfcYTF6+sSTkJj0H5o0Xs3rPgxO3rRZ\nLTEfLayUcesHLDDfzVv0xcFeiOo57VY9lvPdTYH/X3p+8uV3jByOsF0HVrUKr4il\nhyFGY4Zj3mTYlqqmNXSPXbGu7GLqprvx+TGgiFT+Ha0tVmdMCebNA4O1MUenSEKI\nEAoccC/vgTgk73LM6t2g6ZAqhDT2a3A8ILS4IBCVILYIwB1p11cqDhGvkuafSrLb\n+EDLs0TdVTbEjjavgATcbCAZrVxCCkYrSqsoD1kU/opdpyPVuMPsGp2Elkn8\n-----END RSA PRIVATE KEY-----\n\nroot@0ffa9f2d3006:/ansible#\n</code></pre> <pre><code>root@0ffa9f2d3006:/ansible# ansible-playbook k3s_deploy.yml\n\nPLAY [Server prep] ******************************************************************************************************************************************************************************************************************************************************************************************************************************************\n\nTASK [Gathering Facts] **************************************************************************************************************************************************************************************************************************************************************************************************************************************\n[WARNING]: Platform linux on host api.k3s.ujstor.com is using the discovered Python interpreter at /usr/bin/python3.11, but future installation of another Python interpreter could change the meaning of that path. See https://docs.ansible.com/ansible-core/2.17/reference_appendices/interpreter_discovery.html for more information.\nok: [api.k3s.ujstor.com]\n\nTASK [common : Update package lists] ************************************************************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [common : Upgrade all packages] ************************************************************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [common : Install public AuthorizedKeysFile] ***********************************************************************************************************************************************************************************************************************************************************************************************************\nok: [api.k3s.ujstor.com]\n\nTASK [common : Install required packages] *******************************************************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [common : Enable UFW] **********************************************************************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [common : Allow incoming traffic on specified ports] ***************************************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com] =&gt; (item=22)\nchanged: [api.k3s.ujstor.com] =&gt; (item=80)\nchanged: [api.k3s.ujstor.com] =&gt; (item=443)\nchanged: [api.k3s.ujstor.com] =&gt; (item=6443)\nchanged: [api.k3s.ujstor.com] =&gt; (item=587)\n\nTASK [common : Configure Fail2Ban] **************************************************************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [common : Restart fail2ban] ****************************************************************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [common : Ensure no conflicting PermitRootLogin in sshd_config] ****************************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [common : SSH Hardening for root user] *****************************************************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [common : Restart sshd] ********************************************************************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : Enforce minimum Ansible version] *******************************************************************************************************************************************************************************************************************************************************************************************\nok: [api.k3s.ujstor.com] =&gt; {\n    \"changed\": false,\n    \"msg\": \"All assertions passed\"\n}\n\nTASK [k3s.orchestration.prereq : Install Dependent Ubuntu Packages] *****************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : Enable IPv4 forwarding] ****************************************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : Enable IPv6 forwarding] ****************************************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : Populate service facts] ****************************************************************************************************************************************************************************************************************************************************************************************************\nok: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : Get ufw status] ************************************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : If ufw enabled, open api port] *********************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : If ufw enabled, open etcd ports] *******************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : If ufw enabled, allow default CIDRs] ***************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com] =&gt; (item=10.42.0.0/16)\nskipping: [api.k3s.ujstor.com] =&gt; (item=10.43.0.0/16)\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : If firewalld enabled, open api port] ***************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : If firewalld enabled, open etcd ports] *************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : If firewalld enabled, open inter-node ports] *******************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com] =&gt; (item=5001/tcp)\nskipping: [api.k3s.ujstor.com] =&gt; (item=8472/udp)\nskipping: [api.k3s.ujstor.com] =&gt; (item=10250/tcp)\nskipping: [api.k3s.ujstor.com] =&gt; (item=51820/udp)\nskipping: [api.k3s.ujstor.com] =&gt; (item=51821/udp)\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : If firewalld enabled, allow node CIDRs] ************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com] =&gt; (item=159.69.83.103)\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : If firewalld enabled, allow default CIDRs] *********************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com] =&gt; (item=10.42.0.0/16)\nskipping: [api.k3s.ujstor.com] =&gt; (item=10.43.0.0/16)\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : Add br_netfilter to /etc/modules-load.d/] **********************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : Load br_netfilter] *********************************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : Set bridge-nf-call-iptables (just to be sure)] *****************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com] =&gt; (item=net.bridge.bridge-nf-call-iptables)\nskipping: [api.k3s.ujstor.com] =&gt; (item=net.bridge.bridge-nf-call-ip6tables)\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : Check for Apparmor existence] **********************************************************************************************************************************************************************************************************************************************************************************************\nok: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : Check if Apparmor is enabled] **********************************************************************************************************************************************************************************************************************************************************************************************\nok: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : Install Apparmor Parser [Suse]] ********************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : Install Apparmor Parser [Debian]] ******************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : Gather the package facts] **************************************************************************************************************************************************************************************************************************************************************************************************\nok: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : If iptables v1.8.0-1.8.4, warn user] ***************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : Add /usr/local/bin to sudo secure_path] ************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : Make rancher directory] ****************************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : Create symlink] ************************************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : Make manifests directory] **************************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : Copy manifests] ************************************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : Make k3s config directory] *************************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.prereq : Copy config values] ********************************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [Generate random token] ********************************************************************************************************************************************************************************************************************************************************************************************************************************\nok: [api.k3s.ujstor.com]\n\nTASK [Set token fact] ***************************************************************************************************************************************************************************************************************************************************************************************************************************************\nok: [api.k3s.ujstor.com]\n\nPLAY [Setup K3S server] *************************************************************************************************************************************************************************************************************************************************************************************************************************************\n\nTASK [Gathering Facts] **************************************************************************************************************************************************************************************************************************************************************************************************************************************\nok: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Get k3s installed version] *********************************************************************************************************************************************************************************************************************************************************************************************\nfatal: [api.k3s.ujstor.com]: FAILED! =&gt; {\"changed\": false, \"cmd\": \"k3s --version\", \"msg\": \"[Errno 2] No such file or directory: b'k3s'\", \"rc\": 2, \"stderr\": \"\", \"stderr_lines\": [], \"stdout\": \"\", \"stdout_lines\": []}\n...ignoring\n\nTASK [k3s.orchestration.k3s_server : Set k3s installed version] *********************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Download K3s install script] *******************************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Download K3s binary] ***************************************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Add K3s autocomplete to user bashrc] ***********************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Make config directory] *************************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Copy config values] ****************************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Copy K3s service file [Single]] ****************************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Copy K3s service file [HA]] ********************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Add service environment variables] *************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Delete any existing token from the environment if different from the new one] ******************************************************************************************************************************************************************************************************************************************\nok: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Add token as an environment variable] **********************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Restart K3s service] ***************************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Enable and check K3s service] ******************************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Pause to allow first server startup] ***********************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Check whether kubectl is installed on control node] ********************************************************************************************************************************************************************************************************************************************************************\nfatal: [api.k3s.ujstor.com -&gt; 127.0.0.1]: FAILED! =&gt; {\"changed\": false, \"cmd\": \"kubectl\", \"msg\": \"[Errno 2] No such file or directory: b'kubectl'\", \"rc\": 2, \"stderr\": \"\", \"stderr_lines\": [], \"stdout\": \"\", \"stdout_lines\": []}\n...ignoring\n\nTASK [k3s.orchestration.k3s_server : Copy k3s.yaml to second file] ******************************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Copy kubeconfig to control node] ***************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Change server address in kubeconfig on control node] *******************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Setup kubeconfig context on control node - k3s-ansible] ****************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Merge with any existing kubeconfig on control node] ********************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Wait for token] ********************************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Read node-token from master] *******************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Store Master node-token] ***********************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Get the token from the first server] ***********************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Delete any existing token from the environment if different from the new one] ******************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Add the token for joining the cluster to the environment] **************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com] =&gt; (item=None)\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Copy K3s service file [HA]] ********************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Copy K3s service file [External DB]] ***********************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Restart K3s service] ***************************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Enable and check K3s service] ******************************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Verify that all server nodes joined] ***********************************************************************************************************************************************************************************************************************************************************************************\nskipping: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Create directory .kube] ************************************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Copy config file to user home directory] *******************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Configure default KUBECONFIG for user] *********************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [k3s.orchestration.k3s_server : Configure kubectl autocomplete] ****************************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nPLAY [Get kubeconfig] ***************************************************************************************************************************************************************************************************************************************************************************************************************************************\n\nTASK [Gathering Facts] **************************************************************************************************************************************************************************************************************************************************************************************************************************************\nok: [api.k3s.ujstor.com]\n\nTASK [Fetch kubeconfig file from remote server] *************************************************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com]\n\nTASK [Replace server IP in kubeconfig] **********************************************************************************************************************************************************************************************************************************************************************************************************************\nchanged: [api.k3s.ujstor.com -&gt; localhost]\n\nPLAY RECAP **************************************************************************************************************************************************************************************************************************************************************************************************************************************************\napi.k3s.ujstor.com         : ok=39   changed=25   unreachable=0    failed=0    skipped=45   rescued=0    ignored=2\n</code></pre> <pre><code>root@0ffa9f2d3006:/ansible# cat kubeconfig\n\napiVersion: v1\nclusters:\n- cluster:\n    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJkekNDQVIyZ0F3SUJBZ0lCQURBS0JnZ3Foa2pPUFFRREFqQWpNU0V3SHdZRFZRUUREQmhyTTNNdGMyVnkKZG1WeUxXTmhRREUzTXpRNU56QTFPRFF3SGhjTk1qUXhNakl6TVRZeE5qSTBXaGNOTXpReE1qSXhNVFl4TmpJMApXakFqTVNFd0h3WURWUVFEREJock0zTXRjMlZ5ZG1WeUxXTmhRREUzTXpRNU56QTFPRFF3V1RBVEJnY3Foa2pPClBRSUJCZ2dxaGtqT1BRTUJCd05DQUFTY1AwTVRzcHU5dG15cFcvemZEZGt1Zm1tVkdvY2lXZGZDTGp6RlN1ZjIKRCs5QzZYdUpMSG9XTW4xNEg2eitzdU1UWjJSSVhGeEZBSyt1QVc2MStxUVVvMEl3UURBT0JnTlZIUThCQWY4RQpCQU1DQXFRd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFRmdRVVJ6d1hGMTJWQkdLSnl4NEQvSW5sCnZZbk44NnN3Q2dZSUtvWkl6ajBFQXdJRFNBQXdSUUloQUxnTGFFOVYybzFjeThjbTFJbDc1M0EvRXZiWW4wSEgKYUlKVS9yTzVXSzZtQWlBelBnNE1ibStWdnRyYStHZUJvVE52eFVHL1JER29PRHNPZWlFRDFuZlhBQT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K\n    server: https://api.k3s.ujstor.com:6443\n  name: default\ncontexts:\n- context:\n    cluster: default\n    user: default\n  name: default\ncurrent-context: default\nkind: Config\npreferences: {}\nusers:\n- name: default\n  user:\n    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJrVENDQVRlZ0F3SUJBZ0lJYXgwd0VBa1g2SDh3Q2dZSUtvWkl6ajBFQXdJd0l6RWhNQjhHQTFVRUF3d1kKYXpOekxXTnNhV1Z1ZEMxallVQXhOek0wT1Rjd05UZzBNQjRYRFRJME1USXlNekUyTVRZeU5Gb1hEVEkxTVRJeQpNekUyTVRZeU5Gb3dNREVYTUJVR0ExVUVDaE1PYzNsemRHVnRPbTFoYzNSbGNuTXhGVEFUQmdOVkJBTVRESE41CmMzUmxiVHBoWkcxcGJqQlpNQk1HQnlxR1NNNDlBZ0VHQ0NxR1NNNDlBd0VIQTBJQUJKbjIwN0hpRUFvbjFFS1MKWGxxdHptVG5jWG0wb0dRZ3JmK0F0Qjh4SHh5T3NWcnNOMmZCb3M1Q1RHNXVKT0xMeWlTZXVtanRTNnhQQmg1Mwp2N09IenBDalNEQkdNQTRHQTFVZER3RUIvd1FFQXdJRm9EQVRCZ05WSFNVRUREQUtCZ2dyQmdFRkJRY0RBakFmCkJnTlZIU01FR0RBV2dCVGxIMXNaaDhYZTZDWmFybG1oTTU0SHF5M2JiREFLQmdncWhrak9QUVFEQWdOSUFEQkYKQWlBMWZHYmtaTHMxMU4rMkR5QUhjdW1way9GSlZVaG1BNmdtZXN5WmZaV2JCUUloQUttT253YVZYOXZ3KzJMNgppMnJlbjNZQzI1cFdUd1d3Zno2dmhiSmxyVFpsCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0KLS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJlRENDQVIyZ0F3SUJBZ0lCQURBS0JnZ3Foa2pPUFFRREFqQWpNU0V3SHdZRFZRUUREQmhyTTNNdFkyeHAKWlc1MExXTmhRREUzTXpRNU56QTFPRFF3SGhjTk1qUXhNakl6TVRZeE5qSTBXaGNOTXpReE1qSXhNVFl4TmpJMApXakFqTVNFd0h3WURWUVFEREJock0zTXRZMnhwWlc1MExXTmhRREUzTXpRNU56QTFPRFF3V1RBVEJnY3Foa2pPClBRSUJCZ2dxaGtqT1BRTUJCd05DQUFRWm5JMjhVSFc5T1BSd0Zjd3FWTHp2TENoS2U0OGNqNGk5Z0l3NHdKNkoKMTFtRVNKUGhxYnZsT0hNVE42QS9JQlNkZWpOZFliL24vZERidExrUExZSFlvMEl3UURBT0JnTlZIUThCQWY4RQpCQU1DQXFRd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFRmdRVTVSOWJHWWZGM3VnbVdxNVpvVE9lCkI2c3QyMnd3Q2dZSUtvWkl6ajBFQXdJRFNRQXdSZ0loQU0xSzd6bVpLZTYvQXMvRDdCMzFFQnMrOGN1RHFyWlEKUXhHcnJoSUFwY3BnQWlFQWdtWDN4NERTV2M0VzlyKytpRDBmL2U3T3c4L0xYWXJYSHVXdXRTT1Vjbkk9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K\n    client-key-data: LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSUUxS2daTUc0QjkxcXFJWlVHeWxId1k4L1BKS3poZW50RzJoUkxGSGJZOGFvQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFbWZiVHNlSVFDaWZVUXBKZVdxM09aT2R4ZWJTZ1pDQ3QvNEMwSHpFZkhJNnhXdXczWjhHaQp6a0pNYm00azRzdktKSjY2YU8xTHJFOEdIbmUvczRmT2tBPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=\n\n</code></pre>"},{"location":"deployment-logs/terraform/","title":"Terrafrom","text":"<pre><code>terraform init\nInitializing the backend...\nInitializing modules...\nDownloading git::https://github.com/Ujstor/terraform-hetzner-modules.git?ref=v0.0.8 for cloudflare_record...\n- cloudflare_record in .terraform/modules/cloudflare_record/modules/network/cloudflare_record\nDownloading git::https://github.com/Ujstor/terraform-hetzner-modules.git?ref=v0.0.8 for floating_ip...\n- floating_ip in .terraform/modules/floating_ip/modules/network/floating_ip\nDownloading git::https://github.com/Ujstor/terraform-hetzner-modules.git?ref=v0.0.8 for k3s_server...\n- k3s_server in .terraform/modules/k3s_server/modules/server\nDownloading git::https://github.com/Ujstor/terraform-hetzner-modules.git?ref=v0.0.8 for ssh_key_k3s...\n- ssh_key_k3s in .terraform/modules/ssh_key_k3s/modules/ssh_key\nInitializing provider plugins...\n- Finding hetznercloud/hcloud versions matching \"~&gt; 1.47\"...\n- Finding hashicorp/tls versions matching \"~&gt; 4.0\"...\n- Finding cloudflare/cloudflare versions matching \"~&gt; 4.37\"...\n- Installing hetznercloud/hcloud v1.49.1...\n- Installed hetznercloud/hcloud v1.49.1 (signed by a HashiCorp partner, key ID 5219EACB3A77198B)\n- Installing hashicorp/tls v4.0.6...\n- Installed hashicorp/tls v4.0.6 (signed by HashiCorp)\n- Installing cloudflare/cloudflare v4.48.0...\n- Installed cloudflare/cloudflare v4.48.0 (self-signed, key ID C76001609EE3B136)\nPartner and community providers are signed by their developers.\nIf you'd like to know more about provider signing, you can read about it here:\nhttps://www.terraform.io/docs/cli/plugins/signing.html\nTerraform has created a lock file .terraform.lock.hcl to record the provider\nselections it made above. Include this file in your version control repository\nso that Terraform can guarantee to make the same selections by default when\nyou run \"terraform init\" in the future.\n\nTerraform has been successfully initialized!\n\nYou may now begin working with Terraform. Try running \"terraform plan\" to see\nany changes that are required for your infrastructure. All Terraform commands\nshould now work.\n\nIf you ever set or change modules or backend configuration for Terraform,\nrerun this command to reinitialize your working directory. If you forget, other\ncommands will detect it and remind you to do so if necessary.\n</code></pre> <pre><code>\uf432 terraform apply\n\nTerraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:\n  + create\n\nTerraform will perform the following actions:\n\n  # module.cloudflare_record.cloudflare_record.domain_recorda[\"kube_api\"] will be created\n  + resource \"cloudflare_record\" \"domain_recorda\" {\n      + allow_overwrite = false\n      + content         = (known after apply)\n      + created_on      = (known after apply)\n      + hostname        = (known after apply)\n      + id              = (known after apply)\n      + metadata        = (known after apply)\n      + modified_on     = (known after apply)\n      + name            = \"api.k3s\"\n      + proxiable       = (known after apply)\n      + proxied         = false\n      + ttl             = 60\n      + type            = \"A\"\n      + value           = (known after apply)\n      + zone_id         = \"954d9bc1391a15cc29a993894cbf65fb\"\n    }\n\n  # module.cloudflare_record.cloudflare_record.domain_recorda[\"mail\"] will be created\n  + resource \"cloudflare_record\" \"domain_recorda\" {\n      + allow_overwrite = false\n      + content         = (known after apply)\n      + created_on      = (known after apply)\n      + hostname        = (known after apply)\n      + id              = (known after apply)\n      + metadata        = (known after apply)\n      + modified_on     = (known after apply)\n      + name            = \"mail.k3s\"\n      + proxiable       = (known after apply)\n      + proxied         = false\n      + ttl             = 60\n      + type            = \"A\"\n      + value           = (known after apply)\n      + zone_id         = \"954d9bc1391a15cc29a993894cbf65fb\"\n    }\n\n  # module.cloudflare_record.cloudflare_record.domain_recorda[\"mail-dkms\"] will be created\n  + resource \"cloudflare_record\" \"domain_recorda\" {\n      + allow_overwrite = false\n      + content         = \"add config\"\n      + created_on      = (known after apply)\n      + hostname        = (known after apply)\n      + id              = (known after apply)\n      + metadata        = (known after apply)\n      + modified_on     = (known after apply)\n      + name            = \"mail.k3s_domainkey.ujstor.com\"\n      + proxiable       = (known after apply)\n      + ttl             = 1\n      + type            = \"TXT\"\n      + value           = (known after apply)\n      + zone_id         = \"954d9bc1391a15cc29a993894cbf65fb\"\n    }\n\n  # module.cloudflare_record.cloudflare_record.domain_recorda[\"mx\"] will be created\n  + resource \"cloudflare_record\" \"domain_recorda\" {\n      + allow_overwrite = false\n      + content         = \"mail.k3s.ujstor.com\"\n      + created_on      = (known after apply)\n      + hostname        = (known after apply)\n      + id              = (known after apply)\n      + metadata        = (known after apply)\n      + modified_on     = (known after apply)\n      + name            = \"@\"\n      + priority        = 10\n      + proxiable       = (known after apply)\n      + ttl             = (known after apply)\n      + type            = \"MX\"\n      + value           = (known after apply)\n      + zone_id         = \"954d9bc1391a15cc29a993894cbf65fb\"\n    }\n\n  # module.cloudflare_record.cloudflare_record.domain_recorda[\"wildcard_k3s\"] will be created\n  + resource \"cloudflare_record\" \"domain_recorda\" {\n      + allow_overwrite = false\n      + content         = (known after apply)\n      + created_on      = (known after apply)\n      + hostname        = (known after apply)\n      + id              = (known after apply)\n      + metadata        = (known after apply)\n      + modified_on     = (known after apply)\n      + name            = \"*.k3s\"\n      + proxiable       = (known after apply)\n      + proxied         = false\n      + ttl             = 60\n      + type            = \"A\"\n      + value           = (known after apply)\n      + zone_id         = \"954d9bc1391a15cc29a993894cbf65fb\"\n    }\n\n  # module.floating_ip.hcloud_floating_ip.main[\"ip-1\"] will be created\n  + resource \"hcloud_floating_ip\" \"main\" {\n      + delete_protection = false\n      + home_location     = \"nbg1\"\n      + id                = (known after apply)\n      + ip_address        = (known after apply)\n      + ip_network        = (known after apply)\n      + name              = (known after apply)\n      + server_id         = (known after apply)\n      + type              = \"ipv4\"\n    }\n\n  # module.floating_ip.hcloud_floating_ip_assignment.main[\"ip-1\"] will be created\n  + resource \"hcloud_floating_ip_assignment\" \"main\" {\n      + floating_ip_id = (known after apply)\n      + id             = (known after apply)\n      + server_id      = (known after apply)\n    }\n\n  # module.k3s_server.hcloud_server.server[\"k3s-server\"] will be created\n  + resource \"hcloud_server\" \"server\" {\n      + allow_deprecated_images    = false\n      + backup_window              = (known after apply)\n      + backups                    = false\n      + datacenter                 = (known after apply)\n      + delete_protection          = false\n      + firewall_ids               = (known after apply)\n      + id                         = (known after apply)\n      + ignore_remote_firewall_ids = false\n      + image                      = \"debian-12\"\n      + ipv4_address               = (known after apply)\n      + ipv6_address               = (known after apply)\n      + ipv6_network               = (known after apply)\n      + keep_disk                  = false\n      + location                   = \"nbg1\"\n      + name                       = \"k3s-server\"\n      + primary_disk_size          = (known after apply)\n      + rebuild_protection         = false\n      + server_type                = \"cx42\"\n      + shutdown_before_deletion   = false\n      + ssh_keys                   = (known after apply)\n      + status                     = (known after apply)\n\n      + public_net {\n          + ipv4         = (known after apply)\n          + ipv4_enabled = true\n          + ipv6         = (known after apply)\n          + ipv6_enabled = false\n        }\n    }\n\n  # module.ssh_key_k3s.hcloud_ssh_key.default will be created\n  + resource \"hcloud_ssh_key\" \"default\" {\n      + fingerprint = (known after apply)\n      + id          = (known after apply)\n      + labels      = {}\n      + name        = \"k3s_hetzner_key\"\n      + public_key  = (known after apply)\n    }\n\n  # module.ssh_key_k3s.tls_private_key.ssh_key will be created\n  + resource \"tls_private_key\" \"ssh_key\" {\n      + algorithm                     = \"RSA\"\n      + ecdsa_curve                   = \"P224\"\n      + id                            = (known after apply)\n      + private_key_openssh           = (sensitive value)\n      + private_key_pem               = (sensitive value)\n      + private_key_pem_pkcs8         = (sensitive value)\n      + public_key_fingerprint_md5    = (known after apply)\n      + public_key_fingerprint_sha256 = (known after apply)\n      + public_key_openssh            = (known after apply)\n      + public_key_pem                = (known after apply)\n      + rsa_bits                      = 4096\n    }\n\nPlan: 10 to add, 0 to change, 0 to destroy.\n\nChanges to Outputs:\n  + floating_ip_info = {\n      + ip-1 = {\n          + ip = (known after apply)\n        }\n    }\n  + server_info      = {\n      + k3s-server = {\n          + id       = (known after apply)\n          + ip       = (known after apply)\n          + location = \"nbg1\"\n          + status   = (known after apply)\n        }\n    }\n\nDo you want to perform these actions?\n  Terraform will perform the actions described above.\n  Only 'yes' will be accepted to approve.\n\n  Enter a value: yes\n\nmodule.ssh_key_k3s.tls_private_key.ssh_key: Creating...\nmodule.ssh_key_k3s.tls_private_key.ssh_key: Creation complete after 1s [id=69cd99907b9068f36cd9e0c44e5a67c4b952b7ad]\nmodule.ssh_key_k3s.hcloud_ssh_key.default: Creating...\nmodule.ssh_key_k3s.hcloud_ssh_key.default: Provisioning with 'local-exec'...\nmodule.ssh_key_k3s.hcloud_ssh_key.default (local-exec): (output suppressed due to sensitive value in config)\nmodule.ssh_key_k3s.hcloud_ssh_key.default: Creation complete after 0s [id=25750490]\nmodule.k3s_server.hcloud_server.server[\"k3s-server\"]: Creating...\nmodule.k3s_server.hcloud_server.server[\"k3s-server\"]: Still creating... [10s elapsed]\nmodule.k3s_server.hcloud_server.server[\"k3s-server\"]: Creation complete after 18s [id=57930612]\nmodule.floating_ip.hcloud_floating_ip.main[\"ip-1\"]: Creating...\nmodule.floating_ip.hcloud_floating_ip.main[\"ip-1\"]: Creation complete after 1s [id=77602715]\nmodule.floating_ip.hcloud_floating_ip_assignment.main[\"ip-1\"]: Creating...\nmodule.cloudflare_record.cloudflare_record.domain_recorda[\"kube_api\"]: Creating...\nmodule.cloudflare_record.cloudflare_record.domain_recorda[\"mail\"]: Creating...\nmodule.cloudflare_record.cloudflare_record.domain_recorda[\"mail-dkms\"]: Creating...\nmodule.cloudflare_record.cloudflare_record.domain_recorda[\"mx\"]: Creating...\nmodule.cloudflare_record.cloudflare_record.domain_recorda[\"wildcard_k3s\"]: Creating...\nmodule.floating_ip.hcloud_floating_ip_assignment.main[\"ip-1\"]: Creation complete after 0s [id=77602715]\nmodule.cloudflare_record.cloudflare_record.domain_recorda[\"mail\"]: Creation complete after 2s [id=166576bddf808a910eabcd9e9f415837]\nmodule.cloudflare_record.cloudflare_record.domain_recorda[\"kube_api\"]: Creation complete after 2s [id=9dca7e42dcb89a0e2412ae81d337649e]\nmodule.cloudflare_record.cloudflare_record.domain_recorda[\"mail-dkms\"]: Creation complete after 2s [id=989af06dec3500740fa90f2eea3af768]\nmodule.cloudflare_record.cloudflare_record.domain_recorda[\"mx\"]: Creation complete after 2s [id=96f55a5cc4d326552a724ce04424941a]\nmodule.cloudflare_record.cloudflare_record.domain_recorda[\"wildcard_k3s\"]: Creation complete after 3s [id=90e768bde523966ee8e692a1892bcf76]\n\nApply complete! Resources: 10 added, 0 changed, 0 destroyed.\n\nOutputs:\n\nfloating_ip_info = {\n  \"ip-1\" = {\n    \"ip\" = \"116.202.185.83\"\n  }\n}\nserver_info = {\n  \"k3s-server\" = {\n    \"id\" = \"57930612\"\n    \"ip\" = \"159.69.83.103\"\n    \"location\" = \"nbg1\"\n    \"status\" = \"running\"\n  }\n}\n</code></pre>"},{"location":"k3s-components/mailserver/","title":"Mailserver","text":"<p>The MailServer chart deploys a docker-mailserver implementation. While the configuration can be very complex, the official documentation is very good and serves as an excellent guide for understanding and properly configuring the mailserver.</p>"},{"location":"k3s-components/mailserver/#preconfig","title":"Preconfig","text":""},{"location":"k3s-components/mailserver/#dns-records","title":"DNS Records","text":"<p>The node-infra directory, located within the IaC folder, contains Cloudflare DNS records, specifically MX and A records.</p> <pre><code>    mx = {\n      zone_id  = var.cloudflare_zone_id\n      name     = \"@\"\n      content  = \"mail.ujstor.com\"\n      type     = \"MX\"\n      priority = 10\n    }\n    mail = {\n      zone_id = var.cloudflare_zone_id\n      name    = \"mail\"\n      content = module.floating_ip.floating_ip_status.ip-1.ip\n      type    = \"A\"\n      ttl     = 60\n      proxied = false\n    }\n</code></pre>"},{"location":"k3s-components/mailserver/#cert-issuer","title":"Cert Issuer","text":"<p>We can't use the ClusterIssuer that is already deployed because there is no ingress deployed with the mailserver (the service type is LoadBalancer).</p> <p>For this reason, we need to:</p> <ul> <li>Create an API token with read/write permissions</li> <li>Add data to the Issuer object</li> <li>Deploy it in the namespace where the mailserver chart will be deployed with Helm</li> </ul> <pre><code>apiVersion: cert-manager.io/v1\nkind: Issuer\nmetadata:\n  name: letsencrypt-issuer\n  namespace: mailserver\nspec:\n  acme:\n    server: https://acme-v02.api.letsencrypt.org/directory\n    privateKeySecretRef:\n      name: letsencrypt-key\n    solvers:\n    - dns01:\n        cloudflare:\n          apiTokenSecretRef:\n            name: mailserver-issuer\n            key: api-key\n---\napiVersion: v1\nkind: Secret\nmetadata:\n  name: mailserver-issuer\n  namespace: mailserver\ntype: Opaque\nstringData:\n  api-key: &lt;Cloudflare-api-key&gt;\n</code></pre> <p>The chart needs to reference:</p> <ul> <li>The mail domain in the deployment.env.OVERRIDE_HOSTNAME section</li> <li>The issuer name in certificate.issuerRef.name section</li> <li>Specifying the certificate name is enough, and the Certificate object will be created</li> </ul> <pre><code>dockermailserver:\n  deployment:\n    env:\n      OVERRIDE_HOSTNAME: mail.ujstor.com\n  certificate: mailserver-tls\n\ncertificates:\n  organization: Ujstor\n  duration: 2160h\n  renewBefore: 360h\n  issuerRef:\n    name: letsencrypt-issuer\n    kind: Issuer\n</code></pre> <p>The Certificate object is under the templates directory and it will automatically create and mount the mailserver-tls secret to the pod.</p>"},{"location":"k3s-components/mailserver/#network-config","title":"Network config","text":"<p>The service type is LoadBalancer, so we need to add an additional floating IP to the server. This can be achieved with terraform-hetzner-modules that I am using for provisioning Hetzner infrastructure.</p> <pre><code>module \"floating_ip\" {\n  source = \"github.com/Ujstor/terraform-hetzner-modules//modules/network/floating_ip?ref=v0.0.8\"\n\n  floating_ip_config = {\n    ip-1 = {\n      server_id       = module.k3s_server.server_info.k3s-server.id\n      server_location = module.k3s_server.server_info.k3s-server.location\n    }\n  }\n  depends_on = [module.k3s_server]\n}\n</code></pre> <p>And once we have the IP, we need to add it to the MetalLB IPAddressPool.</p> <pre><code>Outputs:\n\nfloating_ip_info = {\n  \"ip-1\" = {\n    \"ip\" = \"49.13.32.42\"\n  }\n}\nserver_info = {\n  \"k3s-server\" = {\n    \"id\" = \"57518060\"\n    \"ip\" = \"188.245.179.200\"\n    \"location\" = \"nbg1\"\n    \"status\" = \"running\"\n  }\n}\n</code></pre> <pre><code>metallb-config:\n  ipAddressPool:\n    addresses:\n     - 188.245.179.200/32\n     - 49.13.32.42/32\n\n  l2Advertisement:\n    enabled: true\n</code></pre> <p>Push to main and ArgoCD will provision MetalLB and mailserver deployment.</p>"},{"location":"k3s-components/mailserver/#mailserver-configuration","title":"MailServer configuration","text":"<p>Once deployed, you will have 120 seconds to create an account. I am using k9s, and by pressing 's' on the pod, you will have an active shell. There are other ways to do this in a more automated way, but for now we are following these steps manually so we can better understand what is happening.</p> <p>Execute the command to create an email account.</p> <pre><code>setup email add admin@ujstor.com password1234\n\nsetup email list\n</code></pre> <p>This is a minimal configuration. Test it with an application that supports SMTP - for example, Uptime Kuma can send you notifications when your website endpoint is unavailable.</p> <p>Forwarding email to Gmail with a minimal configuration will not work. Looking at the logs, you can see the issue: your SMTP server successfully accepts and processes the email, but it's rejected by Gmail's SMTP server. While your server accepts the message and queues it, delivery to Gmail fails.</p> <p>Pod logs:</p> <pre><code>postfix/smtp[5465]: 940A663D054: to=&lt;astipan@gmail.com&gt;, relay=gmail-smtp-in.l.google.com[142.251.31.26]:25, delay=0.48, delays=0.08/0.02/0.05/0.33, dsn=5.7\n</code></pre> <p>The dsn=5.7 error code suggests that Gmail is rejecting the email due to authentication/security requirements.</p> <p>To fix this, you should Generate DKIM key:</p>"},{"location":"k3s-components/mailserver/#dkim-keys","title":"DKIM keys","text":"<p>Create active shell in pod, and execute:</p> <pre><code>setup config dkim\n2024-12-22 19:45:58+00:00 INFO  rspamd-dkim: Creating DKIM keys of type 'rsa' and length '2048' with selector 'mail' for domain 'ujstor.com'\n2024-12-22 19:45:59+00:00 INFO  rspamd-dkim: Successfully created DKIM keys\n2024-12-22 19:45:59+00:00 INFO  rspamd-dkim: Supplying a default configuration (to '/tmp/docker-mailserver/rspamd/override.d/dkim_signing.conf')\nrspamd: stopped\nrspamd: started\n2024-12-22 19:45:59+00:00 INFO  rspamd-dkim: Here is the content of the TXT DNS record mail.k3s._domainkey.ujstor.com that you need to create:\n\nv=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAlKuh1diP0S5sKdXtlMnjqtDijNqXAHnsHo4jRySPS8TgjwJIKuKa8jq4LlsStZoUXcCEGlqJuBnUqVUeOoBkCrJRqQqh3sg1YgPTzKIfqb6Yq10x6N//BftlgvIB7y0I/UdcE6S3i4Umub0xB6/A7pY6tXtqqlT91jDvl1gN2wugQF0unsPrqzVyplOkS8mT2Uz08gtrgf3Aa7gQ+IQo93hciLH0I/Ik9LK5Lfj62J4SfMUAAQBw5gSETi0ZIlzd9xkziBYpx6xDDjqEp8L2fbejstYlERMDIQOaKibvCwG2VF52oIMkNuu7R4qpChjsnbvFqa7hSQCfAluwjl2bfwIDAQAB\n\nrspamd: stopped\nrspamd: started\n</code></pre> <p>Then create new TXT record in Cloudflare DNS with the content provided under iac and run terrafrom apply:</p> <pre><code>    mail-dkms = {\n      zone_id = var.cloudflare_zone_id\n      name    = \"mail.k3s._domainkey.ujstor.com\"\n      content = \"v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAlKuh1diP0S5sKdXtlMnjqtDijNqXAHnsHo4jRySPS8TgjwJIKuKa8jq4LlsStZoUXcCEGlqJuBnUqVUeOoBkCrJRqQqh3sg1YgPTzKIfqb6Yq10x6N//BftlgvIB7y0I/UdcE6S3i4Umub0xB6/A7pY6tXtqqlT91jDvl1gN2wugQF0unsPrqzVyplOkS8mT2Uz08gtrgf3Aa7gQ+IQo93hciLH0I/Ik9LK5Lfj62J4SfMUAAQBw5gSETi0ZIlzd9xkziBYpx6xDDjqEp8L2fbejstYlERMDIQOaKibvCwG2VF52oIMkNuu7R4qpChjsnbvFqa7hSQCfAluwjl2bfwIDAQAB\"\n      type    = \"TXT\"\n      ttl     = 1\n    }\n</code></pre>"},{"location":"k3s-components/mailserver/#test","title":"Test","text":"<p>If you now send an email to Gmail, it will be accepted and delivered.</p> <p>gmass SMTP test logs</p> <pre><code>Connected to smtp://mail.k3s.ujstor.com:587/?starttls=when-available\n&lt;&lt; 220 mail.k3s.ujstor.com ESMTP\n&gt;&gt; EHLO [172.31.11.248]\n&lt;&lt; 250-mail.ujstor.com\n&lt;&lt; 250-PIPELINING\n&lt;&lt; 250-SIZE 10240000\n&lt;&lt; 250-ETRN\n&lt;&lt; 250-STARTTLS\n&lt;&lt; 250-ENHANCEDSTATUSCODES\n&lt;&lt; 250-8BITMIME\n&lt;&lt; 250-DSN\n&lt;&lt; 250 CHUNKING\n&gt;&gt; STARTTLS\n&lt;&lt; 220 2.0.0 Ready to start TLS\n&gt;&gt; EHLO [172.31.11.248]\n&lt;&lt; 250-mail.ujstor.com\n&lt;&lt; 250-PIPELINING\n&lt;&lt; 250-SIZE 10240000\n&lt;&lt; 250-ETRN\n&lt;&lt; 250-AUTH PLAIN LOGIN\n&lt;&lt; 250-AUTH=PLAIN LOGIN\n&lt;&lt; 250-ENHANCEDSTATUSCODES\n&lt;&lt; 250-8BITMIME\n&lt;&lt; 250-DSN\n&lt;&lt; 250 CHUNKING\n&gt;&gt; AUTH PLAIN AGFkbWluQHVqc3Rvci5jb20AcGFzc3dvcmQxMjM0\n&lt;&lt; 235 2.7.0 Authentication successful\n&gt;&gt; MAIL FROM:&lt;admin@ujstor.com&gt; SIZE=551\n&gt;&gt; RCPT TO:&lt;astipan@gmail.com&gt;\n&lt;&lt; 250 2.1.0 Ok\n&lt;&lt; 250 2.1.5 Ok\n&gt;&gt; DATA\n&lt;&lt; 354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;\n&gt;&gt; From: admin@ujstor.com\n&gt;&gt; Date: Sun, 22 Dec 2024 19:56:52 \ud34d\n&gt;&gt; Subject: SMTP test from mail.ujstor.com\n&gt;&gt; Message-Id: &lt;NDGOPQ70YOU4.5VT4A0G77RFU3@WIN-AUIR3RRGP88&gt;\n&gt;&gt; To: astipan@gmail.com\n&gt;&gt; MIME-Version: 1.0\n&gt;&gt; Content-Type: multipart/alternative; boundary=\"=-qL2\uf2ba\ud57a\u8ffc\ucf8d\u7618\ue5d5==\"\n&gt;&gt;\n&gt;&gt; --=-qL2\uf2ba\ud57a\u8ffc\ucf8d\u7618\ue5d5==\n&gt;&gt; Content-Type: text/plain; charset=utf-8\n&gt;&gt;\n&gt;&gt; Test message\n&gt;&gt; --=-qL2\uf2ba\ud57a\u8ffc\ucf8d\u7618\ue5d5==\n&gt;&gt; Content-Type: text/html; charset=utf-8\n&gt;&gt; Content-Id: &lt;NDGOPQ70YOU4.8C46H6CU77TD@WIN-AUIR3RRGP88&gt;\n&gt;&gt;\n&gt;&gt; &lt;b&gt;Test message&lt;/b&gt;\n&gt;&gt; --=-qL2\uf2ba\ud57a\u8ffc\ucf8d\u7618\ue5d5==--\n&gt;&gt; .\n&lt;&lt; 250 2.0.0 Ok: queued as EF1B7645EE7\n</code></pre> <p>Pod logs</p> <pre><code>24-12-22 19:40:43+00:00 INFO  start-mailserver.sh: Welcome to docker-mailserver v14.0.0                                                                                                                                                                                                                                                                     \u2502\n\u2502 2024-12-22 19:40:43+00:00 INFO  start-mailserver.sh: Checking configuration                                                                                                                                                                                                                                                                               \u2502\n\u2502 2024-12-22 19:40:43+00:00 INFO  start-mailserver.sh: Configuring mail server                                                                                                                                                                                                                                                                              \u2502\n\u2502 2024-12-22 19:40:43+00:00 WARN  start-mailserver.sh: You need at least one mail account to start Dovecot (120s left for account creation before shutdown)                                                                                                                                                                                                 \u2502\n\u2502 2024-12-22 19:40:53+00:00 WARN  start-mailserver.sh: You need at least one mail account to start Dovecot (110s left for account creation before shutdown)                                                                                                                                                                                                 \u2502\n\u2502 2024-12-22 19:41:03+00:00 WARN  start-mailserver.sh: You need at least one mail account to start Dovecot (100s left for account creation before shutdown)                                                                                                                                                                                                 \u2502\n\u2502 2024-12-22 19:41:13+00:00 WARN  start-mailserver.sh: You need at least one mail account to start Dovecot (90s left for account creation before shutdown)                                                                                                                                                                                                  \u2502\n\u2502 2024-12-22 19:41:24+00:00 INFO  start-mailserver.sh: Starting daemons                                                                                                                                                                                                                                                                                     \u2502\n\u2502 2024-12-22 19:41:27+00:00 INFO  start-mailserver.sh: mail.k3s.ujstor.com is up and running                                                                                                                                                                                                                                                                    \u2502\n\u2502 tail: inotify cannot be used, reverting to polling: Too many open files                                                                                                                                                                                                                                                                                   \u2502\n\u2502 2024-12-22T19:41:27.823323+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/postfix-script[932]: starting the Postfix mail system                                                                                                                                                                                                               \u2502\n\u2502 2024-12-22T19:41:27.840527+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/master[933]: daemon started -- version 3.7.10, configuration /etc/postfix                                                                                                                                                                                           \u2502\n\u2502 2024-12-22 19:45:59,990 WARN stopped: rspamd (terminated by SIGTERM)                                                                                                                                                                                                                                                                                      \u2502\n\u2502 2024-12-22T19:56:51.364820+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/submission/smtpd[4467]: connect from ec2-54-212-131-181.us-west-2.compute.amazonaws.com[54.212.131.181]                                                                                                                                                             \u2502\n\u2502 2024-12-22T19:56:52.324327+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/submission/smtpd[4467]: Anonymous TLS connection established from ec2-54-212-131-181.us-west-2.compute.amazonaws.com[54.212.131.181]: TLSv1.2 with cipher DHE-RSA-AES128-GCM-SHA256 (128/128 bits)                                                                  \u2502\n\u2502 2024-12-22T19:56:52.979665+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/submission/smtpd[4467]: EF1B7645EE7: client=ec2-54-212-131-181.us-west-2.compute.amazonaws.com[54.212.131.181], sasl_method=PLAIN, sasl_username=admin@ujstor.com                                                                                                   \u2502\n\u2502 2024-12-22T19:56:53.355001+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/sender-cleanup/cleanup[4477]: EF1B7645EE7: message-id=&lt;NDGOPQ70YOU4.5VT4A0G77RFU3@WIN-AUIR3RRGP88&gt;                                                                                                                                                                  \u2502\n\u2502 2024-12-22T19:56:53.355079+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/sender-cleanup/cleanup[4477]: EF1B7645EE7: replace: header MIME-Version: 1.0 from ec2-54-212-131-181.us-west-2.compute.amazonaws.com[54.212.131.181]; from=&lt;admin@ujstor.com&gt; to=&lt;astipan@gmail.com&gt; proto=ESMTP helo=&lt;[172.31.11.248]&gt;: MIME-Version: 1.0          \u2502\n\u2502 2024-12-22T19:56:53.580667+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/qmgr[935]: EF1B7645EE7: from=&lt;admin@ujstor.com&gt;, size=585, nrcpt=1 (queue active)                                                                                                                                                                                   \u2502\n\u2502 2024-12-22T19:56:53.722477+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/smtp[4478]: Trusted TLS connection established to gmail-smtp-in.l.google.com[142.251.31.27]:25: TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits) key-exchange X25519 server-signature ECDSA (prime256v1) server-digest SHA256                              \u2502\n\u2502 2024-12-22T19:56:53.761942+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/submission/smtpd[4467]: disconnect from ec2-54-212-131-181.us-west-2.compute.amazonaws.com[54.212.131.181] ehlo=2 starttls=1 auth=1 mail=1 rcpt=1 data=1 commands=7                                                                                                 \u2502\n\u2502 2024-12-22T19:56:54.285473+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/smtp[4478]: EF1B7645EE7: to=&lt;astipan@gmail.com&gt;, relay=gmail-smtp-in.l.google.com[142.251.31.27]:25, delay=1.3, delays=0.62/0.03/0.14/0.54, dsn=2.0.0, status=sent (250 2.0.0 OK  1734897414 a640c23a62f3a-aac0f040f87si490882066b.477 - gsmtp)                     \u2502\n\u2502 2024-12-22T19:56:54.286079+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/qmgr[935]: EF1B7645EE7: removed \n</code></pre>"},{"location":"k3s-components/mailserver/#test-tools","title":"Test tools","text":"<ul> <li>The complete IP check for sending Mailservers: https://multirbl.valli.org/</li> <li>SMTP test: https://www.gmass.co/smtp-test</li> </ul>"},{"location":"k3s-components/mailserver/#useful-commands","title":"Useful commands","text":"<pre><code>setup email add admin@example.com passwd123\nsetup email add info@example.com passwd123\nsetup alias add admin@example.com external-account@gmail.com\nsetup alias add info@example.com external-account@gmail.com\nsetup email list\nsetup alias list\nsetup email del admin@example.com\n</code></pre>"},{"location":"quick-start/ansible/","title":"Ansible","text":"<p>Ansible is not listed in requirements for a reason. We have encapsulated Ansible configuration and run it in a Docker container.</p> <p>From the project root, run the following command to build the Docker image:</p> <pre><code>docker build -t  ansible-k3s ./ansible .\n</code></pre>"},{"location":"quick-start/ansible/#inventory","title":"Inventory","text":"<p>To achieve the minimal K3s deployment mentioned earlier, note these key configurations in the inventory file:</p> <pre><code>server:\n  hosts:\n    api.k3s.ujstor.com:\n  vars:\n    k3s_version: v1.31.3+k3s1\n    api_endpoint: \"{{ groups['server'] | first }}\"\n    extra_server_args: &gt;-\n      --cluster-cidr=10.255.0.0/16\n      --service-cidr=10.254.0.0/16\n      --disable servicelb\n      --disable traefik\n      --flannel-backend=none\n      --egress-selector-mode=disabled\n      --disable-cloud-controller\n      --disable-helm-controller\n      --disable-network-policy\n      --disable-kube-proxy\n      --tls-san {{ api_endpoint }}\n</code></pre>"},{"location":"quick-start/ansible/#run-ansible","title":"Run Ansible","text":"<p>We are mounting SSH keys (created by Terraform) and the inventory file to the container:</p> <pre><code>docker run --rm -it \\\n    -v $(pwd)/inventory.yml:/config/inventory.yml \\\n    -v $(pwd)/terraform/hetzner-node/.ssh/k3s_hetzner_key:/secrets/ssh_key \\\n    -v $(pwd)/terraform/hetzner-node/.ssh/k3s_hetzner_key.pub:/secrets/ssh_key.pub \\\n    ansible-k3s\n</code></pre> <p>Ansible is custom configured in ansible.cfg, which is why mounting points can be different from classic Ansible configuration.</p> <pre><code>ansible-playbook k3s_deploy.yml\n</code></pre>"},{"location":"quick-start/ansible/#kubeconfig","title":"Kubeconfig","text":"<p>After the Ansible playbook finishes, you will have a kubeconfig file in the Docker container's root. These files are used to access the K3s clusters. Save them and later, you can back up these files in the same MinIO tenant as your Terraform state and SSH keys.</p> <pre><code>cat kubeconfig\n</code></pre> <p>In the next steps, we will deploy Cilium and ArgoCD on the K3s0 cluster and see real magic happen.</p>"},{"location":"quick-start/helm/","title":"Helm","text":"<p>One more thing needs to be preconfigured before we can apply the Argo App of Apps. Take IPs from the Terraform output and add them to metallb-config.yaml Helm chart. These IPs will be used by MetalLB to assign external IPs to services.</p> <pre><code>metallb-config:\n  ipAddressPool:\n    addresses:\n     - 159.69.83.103/32 # Node ip\n     - 116.202.185.83/32 # Floating IP for mailserver\n\n  l2Advertisement:\n    enabled: true\n</code></pre> <p>Push changes to the GitHub repository and ArgoCD will apply them after the next steps.</p>"},{"location":"quick-start/helm/#install-cilium","title":"Install Cilium:","text":"<p>Change directory to the Cilium Helm chart config and run:</p> <pre><code>helm install cilium . -n kube-system\n</code></pre> <p>Observe in k9s when networking is applied: CoreDNS, local-path-provisioner, and metrics-server pods will be running and cluster IPs will be assigned.</p> <p></p>"},{"location":"quick-start/helm/#install-argo-cd","title":"Install Argo CD:","text":"<p>Create a namespace for Argo CD:</p> <pre><code>kubectl create namespace gitops\n</code></pre> <p>Change directory to the ArgoCD Helm chart config and run:</p> <pre><code>helm install argocd . -n gitops\n</code></pre> <p>Check when ArgoCD is installed, you can do port-forwarding to the ArgoCD pod and log in with the password that can be grabbed from the secrets (use k9s, it's easier than raw kubectl commands). </p> <p></p> <p>Finaly apply <code>aoa.yaml</code> in the <code>gitops</code> namespace:</p> <pre><code>kubectl apply -f ./helm/aoa.yaml -n gitops\n</code></pre> <p>In 5 minutes, other components of the K3s cluster will be deployed.</p> <p></p>"},{"location":"quick-start/overview/","title":"Overview","text":"<p>First step is to create API key in the Hetzner Cloud Console and Cloudflare API key in the Cloudflare dashboard for domain management. Import them as secrets in ./terraform/hetzner_node/.auto.tfvars file:</p> <pre><code>hcloud_token = \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\"\ncloudflare_api_token = \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\"\ncloudflare_zone_id   = \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\"\n</code></pre>"},{"location":"quick-start/overview/#order-of-execution","title":"Order of Execution","text":"<p>We need to use Terraform, Ansible, Helm and kubectl to deploy the infrastructure:</p> <ol> <li>We are creating SSH keys and node in Hetzner Cloud with Terraform</li> <li>Ansible will deploy K3s</li> <li>We will deploy Cilium and ArgoCD</li> <li>Apply App of Apps to finish the setup and bootstrap</li> </ol>"},{"location":"quick-start/overview/#helm-charts-configuration","title":"Helm charts configuration","text":"<p>The Helm charts are configured in values.yaml and are imported as dependencies from a repository. They contain my personal configuration, but you can modify them to suit your needs. Do not blindly apply them - check every configuration.</p>"},{"location":"quick-start/overview/#project-tree","title":"Project tree","text":"<pre><code>[4.0K]  ./\n\u251c\u2500\u2500 [4.0K]  ansible/\n\u2502   \u251c\u2500\u2500 [4.0K]  roles/\n\u2502   \u2502   \u2514\u2500\u2500 [4.0K]  common/\n\u2502   \u2502       \u251c\u2500\u2500 [4.0K]  defaults/\n\u2502   \u2502       \u251c\u2500\u2500 [4.0K]  tasks/\n\u2502   \u2502       \u2514\u2500\u2500 [4.0K]  templates/\n\u2502   \u251c\u2500\u2500 [ 239]  ansible.cfg\n\u2502   \u251c\u2500\u2500 [ 459]  Dockerfile\n\u2502   \u251c\u2500\u2500 [1.3K]  k3s_deploy.yml\n\u2502   \u251c\u2500\u2500 [ 207]  k3s_remove.yml\n\u2502   \u2514\u2500\u2500 [ 169]  requirements.yml\n\u251c\u2500\u2500 [4.0K]  helm/\n\u2502   \u251c\u2500\u2500 [4.0K]  app-of-apps/\n\u2502   \u2502   \u251c\u2500\u2500 [ 509]  100_system_cilium.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 694]  110_system_metallb_operator.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 698]  120_system_metallb_config.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 720]  150_system_ingress_nginx.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 723]  200_system_cert_manager.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 699]  300_system_cluster_issuer.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 682]  400_system_postgres_operator.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 641]  410_system_minio_operator.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 645]  420_system_gitlab_operator.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 649]  500_system_external_secrets.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 609]  600_system_argocd.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 689]  700_system_prometheus_grafana.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 601]  900_app_gitea.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 657]  910_app_github_readme_stats_api.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 616]  910_app_portfolio.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 625]  920_app_mailserver.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 629]  925_app_streamlit_wh.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 629]  930_app_todo_go_htmx.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 613]  935_app_fastapi.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 625]  940_app_notes_flask.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 625]  945_app_todo_django.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 769]  950_app_plausible_analytics.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 625]  955_app_uptime_kuma.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 626]  960_app_wordpress_ds.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 822]  970_app_harbor.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 605]  980_app_gitlab.yaml\n\u2502   \u2502   \u251c\u2500\u2500 [ 859]  990_app_s3_storage.yaml\n\u2502   \u2502   \u2514\u2500\u2500 [ 550]  AppProject.yaml\n\u2502   \u251c\u2500\u2500 [4.0K]  apps/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  fastapi/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  gitea/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  github-readme-stats/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  gitlab/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  harbor/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  mailserver/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  notes-flask/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  plausible-analytics/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  portfolio/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  s3-storage/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  streamlit-wh/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  todo-django/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  todo-go-htmx/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  uptime-kuma/\n\u2502   \u2502   \u2514\u2500\u2500 [4.0K]  wordpress-ds/\n\u2502   \u251c\u2500\u2500 [4.0K]  system/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  argocd/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  cert-manager/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  cilium/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  cluster-issuer/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  external-secrets/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  gitlab-operator/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  ingress-nginx/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  metallb-config/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  metallb-operator/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  minio-operator/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  postgres-operator/\n\u2502   \u2502   \u2514\u2500\u2500 [4.0K]  prometheus-grafana/\n\u2502   \u2514\u2500\u2500 [ 379]  aoa.yaml\n\u251c\u2500\u2500 [4.0K]  terraform/\n\u2502   \u251c\u2500\u2500 [4.0K]  hetzner-node/\n\u2502   \u2502   \u251c\u2500\u2500 [1.1K]  cloudflare_dns.tf\n\u2502   \u2502   \u251c\u2500\u2500 [ 934]  main.tf\n\u2502   \u2502   \u251c\u2500\u2500 [ 144]  output.tf\n\u2502   \u2502   \u251c\u2500\u2500 [ 26K]  terraform.tfstate\n\u2502   \u2502   \u251c\u2500\u2500 [ 911]  terrafrom.tf\n\u2502   \u2502   \u2514\u2500\u2500 [ 329]  variables.tf\n\u2502   \u251c\u2500\u2500 [4.0K]  s3-kubeconfig-backup/\n\u2502   \u2502   \u251c\u2500\u2500 [ 649]  main.tf\n\u2502   \u2502   \u251c\u2500\u2500 [ 120]  outputs.tf\n\u2502   \u2502   \u251c\u2500\u2500 [ 879]  terraform.tf\n\u2502   \u2502   \u2514\u2500\u2500 [ 159]  variables.tf\n\u2502   \u251c\u2500\u2500 [4.0K]  s3-ssh-keys-backup/\n\u2502   \u2502   \u251c\u2500\u2500 [ 614]  main.tf\n\u2502   \u2502   \u251c\u2500\u2500 [ 120]  outputs.tf\n\u2502   \u2502   \u251c\u2500\u2500 [ 880]  terraform.tf\n\u2502   \u2502   \u2514\u2500\u2500 [ 150]  variables.tf\n\u2502   \u2514\u2500\u2500 [4.0K]  s3-tf-state/\n\u2502       \u251c\u2500\u2500 [ 254]  main.tf\n\u2502       \u251c\u2500\u2500 [ 120]  outputs.tf\n\u2502       \u251c\u2500\u2500 [ 426]  terraform.tf\n\u2502       \u2514\u2500\u2500 [ 151]  variables.tf\n\u251c\u2500\u2500 [ 171]  docker-config.yml\n\u251c\u2500\u2500 [2.6K]  docker_tag.sh*\n\u251c\u2500\u2500 [ 505]  inventory.yml\n\u251c\u2500\u2500 [1.0K]  LICENSE\n\u251c\u2500\u2500 [1.0K]  Makefile\n\u2514\u2500\u2500 [1.3K]  README.md\n</code></pre>"},{"location":"quick-start/terraform/","title":"Terrafrom","text":"<p>In the hetzner-node directory, main.tf defines what infrastructure will be created. The cloudflare_dns.tf is a module that creates DNS records in Cloudflare. DNS records use wildcards. We also have specific domain for the Kubernetes API, which is referenced in the Ansible inventory file. There are also records for mail server config.</p>"},{"location":"quick-start/terraform/#preconfiguration","title":"Preconfiguration","text":""},{"location":"quick-start/terraform/#terraform-backend","title":"Terraform backend","text":"<p>Current terraform.tf, where providers are defined, assumes that you have a MinIO S3 bucket deployed for storing Terraform state. On the first run, when you don't have your infrastructure up and running, comment out the S3 backend. Later you can migrate your state to the S3 bucket.</p> <pre><code>terraform {\n  # backend \"s3\" {\n  #   bucket                      = \"tf-state-k3s0-k3s1-cluster\"\n  #   key                         = \"nodes-infra-tfstate/terraform.tfstate\"\n  #   region                      = \"us-east-1\"\n  #   skip_credentials_validation = true\n  #   skip_metadata_api_check     = true\n  #   skip_region_validation      = true\n  #   skip_requesting_account_id  = true\n  #   force_path_style            = true\n  #   endpoint                    = \"https://s3.k3s0.ujstor.com\"\n  # }\n  required_providers {\n    hcloud = {\n      source  = \"hetznercloud/hcloud\"\n      version = \"~&gt; 1.47\"\n    }\n    tls = {\n      source  = \"hashicorp/tls\"\n      version = \"~&gt; 4.0\"\n    }\n    cloudflare = {\n      source  = \"cloudflare/cloudflare\"\n      version = \"~&gt; 4.37\"\n    }\n  }\n  required_version = \"&gt;= 1.0.0, &lt; 2.0.0\"\n}\n\nprovider \"hcloud\" {\n  token = var.hcloud_token\n}\n\nprovider \"cloudflare\" {\n  api_token = var.cloudflare_api_token\n}\n</code></pre>"},{"location":"quick-start/terraform/#ssh-keys","title":"SSH Keys","text":"<p>SSH keys will be automatically generated when you run <code>terraform apply</code>, but Terraform expects an .ssh directory inside the hetzner-node dir. Later, you can back up your keys in the same MinIO tenant as your Terraform state. Check config in s3-ssh-keys-backup dir.</p>"},{"location":"quick-start/terraform/#create-infrastructure","title":"Create Infrastructure","text":"<p>Once you have the API keys in the .auto.tfvars file, you can create the infrastructure:</p> <pre><code>terraform init\nterraform apply\n</code></pre> <p>Now you have two servers up and running. The next step is to deploy K3s using Ansible.</p>"}]}